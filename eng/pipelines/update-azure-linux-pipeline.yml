# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# For info about runtime parameters, see https://github.com/microsoft/go-infra/blob/main/docs/pipeline-yml-style.md#runtime-parameters
parameters:
  - name: releaseVersions
    displayName: >
      List of versions to release. Include Microsoft revision suffix (-1) and boring/FIPS suffix
      (-fips) if they apply. Write in YAML format: write one version number per line with '-' and a
      space at the beginning of each line.
    type: object

  # If someone's manually queueing this build, let them skip the approval stage. It takes time to
  # acquire a serverless agent to present the approval step, so the dev has to pay attention and
  # catch it. Instead, let them approve it ahead of time by skipping it. The default is always used
  # by automation, so this is only used for dev builds and retries.
  - name: approveAheadOfTime
    displayName: Approve right now, skipping the approval stage.
    type: boolean
    default: false

  # Allow disabling specific parts of the internal build release. These can be used to re-run
  # specific parts of a release if necessary, e.g. if a step silently failed.
  - name: runMirrorPipeline
    displayName: Remotely trigger mirror pipeline
    type: boolean
    default: true
  - name: runCreatePullRequest
    displayName: Create Pull Request on Azure Linux repo
    type: boolean
    default: true
  - name: runBuddyBuildPipeline
    displayName: Remotely trigger buddy build pipeline
    type: boolean
    default: true

  # This parameter intentionally has no default: see release-go-pipeline.yml
  - name: goReleaseConfigVariableGroup
    displayName: '[Use "go-release-config" for a real release] Variable group that specifies release target locations and auth.'
    type: string

trigger: none
pr: none

variables:
  - group: Microsoft-GoLang-bot
  # Import config group. This may direct the build to use secrets from the other groups.
  - group: ${{ parameters.goReleaseConfigVariableGroup }}
  - name: SourceTarballPublishingPipelineID
    value: '2284'
  - name: assetJsonPath
    value: $(Pipeline.Workspace)/build/BuildAssets/assets.json
resources:
  repositories:
    - repository: 1ESPipelineTemplates
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    sdl:
      sourceAnalysisPool:
        name: NetCore1ESPool-Svc-Internal
        image: 1es-ubuntu-2004
        os: linux
      suppression:
        suppressionFile: $(Build.SourcesDirectory)/.config/guardian/.gdnsuppress
      tsa:
        enabled: true
        configFile: $(Build.SourcesDirectory)/.config/tsa/tsaoptions.json

    stages:
      - ${{ if eq(parameters.approveAheadOfTime, false) }}:
        - stage: WaitForApproval
          jobs:
            - job: Approve
              pool: server
              timeoutInMinutes: 1440 # 1 day
              steps:
                - task: ManualValidation@0
                  inputs:
                    instructions: >
                      Once the microsoft/go build is complete, approve this step to automatically update 
                      the Azure Linux specfiles and create a pull request.
                    onTimeout: 'reject'

      - stage: Release
        jobs:
          - template: /eng/pipelines/jobs/releasego.yml@self
            parameters:
              retryInstructionsFlags: '-preapproval'
              steps:
                # Resume the build at the furthest step based on the inputs. A fresh build has all 'nil', a
                # retry build will have a non-nil value in one of these parameters. Only the value of the last
                # step's parameter matters.
                - download: build
                  artifact: BuildAssets

                - ${{ if eq(parameters.runMirrorPipeline, true) }}:
                  - script: |
                      releasego build-pipeline \
                        -id '$(SourceTarballPublishingPipelineID)' \
                        -org 'https://dev.azure.com/mariner-org/' \
                        -proj 'mariner' \
                        -azdopat '$(System.AccessToken)' \
                        -set-azdo-variable poll2SourceTarballPublishingBuildID \
                        p fileName
                        p tarballUrl
                        # TODO
                    displayName: ðŸš€ Start go-images build/publish
                  - template: ../steps/report.yml
                    parameters:
                      releaseIssueÃŸ: ${{ parameters.releaseIssue }}
                      condition: succeeded()
                      buildPipeline: Source Tarball Publishing
                      buildID: $(poll2SourceTarballPublishingBuildID)
                      buildStatus: '?'
                      start: true
                      reason: queued build
                  # Now we have poll2SourceTarballPublishingBuildID
                  - script: |
                      releasego wait-build \
                        -id '$(poll2SourceTarballPublishingBuildID)' \
                        -org 'https://dev.azure.com/mariner-org/' \
                        -proj 'mariner' \
                        -azdopat '$(System.AccessToken)'
                    displayName: âŒš Wait for Azure Linux Source Tarball Publishing
                    timeoutInMinutes: 120

                - ${{ if eq(parameters.runCreatePullRequest, true) }}:
                  - script: |
                      releasego update-azure-linux \
                        -pat '$(GitHubPAT)'
                    displayName: ðŸ“° Publish announcement details

                - template: ../steps/report.yml
                  parameters:
                    releaseIssue: ${{ parameters.releaseIssue }}
                    condition: succeeded()
                    buildPipeline: Source Tarball Publishing
                    buildID: $(poll2SourceTarballPublishingBuildID)
                    buildStatus: Succeeded
                    reason: completed internal build
