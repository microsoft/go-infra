// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.

package main

import (
	"fmt"
	"os"
	"os/exec"
	"path/filepath"
	"strings"

	"github.com/microsoft/go-infra/executil"
	"github.com/microsoft/go-infra/subcmd"
)

func init() {
	subcommands = append(subcommands, subcmd.Option{
		Name:    "rebase",
		Summary: "Run 'git rebase -i' on the commits created by 'apply'.",
		Description: `

This command rebases the commits applied to the submodule based on patch files. It uses the HEAD
commit recorded by "apply" as the base commit.

You can use this command to apply fixup and squash commits generated by the "git commit" args
"--fixup" and "--squash". To do this, configure Git using "git config --global rebase.autoSquash 1"
before running this command.

Be aware that editing earlier patch files may cause conflicts with later patch files.
` + repoRootSearchDescription,
		Handle: handleRebase,
	})
}

func handleRebase(p subcmd.ParseFunc) error {
	if err := p(); err != nil {
		return err
	}

	config, err := loadConfig()
	if err != nil {
		return err
	}
	_, goDir := config.FullProjectRoots()

	since, err := readStatusFile(config.FullPrePatchStatusFilePath())
	if err != nil {
		return err
	}

	cmd := exec.Command("git", "rebase", "-i", since)
	cmd.Stdin = os.Stdin
	cmd.Dir = goDir

	if err := executil.Run(cmd); err != nil {
		return err
	}

	warnIfOutsideSubmodule(goDir)
	return nil
}

func warnIfOutsideSubmodule(submoduleDir string) {
	const unexpected = "WARNING: Unexpected error while checking if working dir is inside submodule: "

	wd, err := os.Getwd()
	if err != nil {
		fmt.Printf("%vunable to get working dir: %v\n", unexpected, wd)
		return
	}

	rel, err := filepath.Rel(submoduleDir, wd)
	if err != nil {
		fmt.Printf("%vunable to calculate relative path from %#q to %#q: %v", unexpected, submoduleDir, wd, err)
		return
	}
	invRel, err := filepath.Rel(wd, submoduleDir)
	if err != nil {
		fmt.Printf("%vunable to calculate inverse relative path from %#q to %#q: %v", wd, unexpected, submoduleDir, err)
		return
	}

	// Handle ".." and "../foo" separately to properly handle "..foo" special case.
	if rel == ".." || strings.HasPrefix(rel, filepath.FromSlash("../")) {
		fmt.Printf("\nWARNING: The current working directory is not inside the submodule!\n"+
			"  Working dir %#q relative to %#q is %#q.\n"+
			"  To continue the rebase process in this terminal with Git commands:\n\n"+
			"    cd %v\n",
			wd, submoduleDir, rel, invRel)
	}
}
